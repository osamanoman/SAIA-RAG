# SAIA-RAG Production Caddy Configuration
# Domain: saia-demo.bineyes.sa

saia-demo.bineyes.sa {
    # Reverse proxy to FastAPI application
    reverse_proxy api:8000 {
        # Health check
        health_uri /health
        health_interval 30s
        health_timeout 10s
        
        # Headers for proper forwarding
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }
    
    # Security headers
    header {
        # Remove server info
        -Server
        
        # Security headers
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
        
        # CORS headers (adjust origins as needed)
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    }
    
    # Handle preflight requests
    @options {
        method OPTIONS
    }
    respond @options 204
    
    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }
    
    # Rate limiting would require additional Caddy plugins
    # For basic rate limiting, consider using fail2ban or similar tools
}

# HTTP redirect to HTTPS
http://saia-demo.bineyes.sa {
    redir https://saia-demo.bineyes.sa{uri} permanent
}
